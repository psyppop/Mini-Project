<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Police Investigation Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <style>
        #save-button {
            display: block; /* Show normally */
        }

        @media print {
            #save-button {
                display: none; /* Hide in PDF */
            }
        }

        .hide-in-pdf {
            display: none !important;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .section-title {
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .label {
            font-weight: bold;
        }
        .signature-section {
            margin-top: 50px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .signature-box {
            border-top: 1px solid #000;
            padding-top: 5px;
            text-align: center;
        }
        input, textarea, select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
        }
        .checkbox-group {
            display: flex;
            gap: 10px;
        }
        .add-row-btn, .add-person-btn {
            background-color: #4a5568;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        .remove-row-btn, .remove-person-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .remove-row-btn:hover, .remove-person-btn:hover {
            background-color: #ff3333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .remove-row-btn::before, .remove-person-btn::before {
            content: 'âœ–';
            font-size: 10px;
        }
    </style>
   <script>
    // Initialize Signature Pads when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize static signature pads (signature-pad-3 and signature-pad-4)
        const canvas3 = document.getElementById('signature-pad-3');
        const canvas4 = document.getElementById('signature-pad-4');

        if (canvas3) {
            new SignaturePad(canvas3);
        } else {
            console.error('Canvas with ID "signature-pad-3" not found!');
        }

        if (canvas4) {
            new SignaturePad(canvas4);
        } else {
            console.error('Canvas with ID "signature-pad-4" not found!');
        }
    });

    // Function to add a new statement row
    function addStatementRow() {
        const table = document.getElementById('statements-table');
        const newRow = table.insertRow(-1);
        newRow.innerHTML = `
            <td><input type="text" placeholder="Witness Name"></td>
            <td><input type="date"></td>
            <td><textarea placeholder="Statement Details"></textarea></td>
            <td><input type="text" placeholder="Section"></td>
            <td><button onclick="removeTableRow(this)" class="remove-row-btn">Remove</button></td>
        `;
    }

    // Function to remove a table row
    function removeTableRow(btn) {
        btn.closest('tr').remove();
    }

    // Function to add a new person detail section
    function addPersonDetail() {
        const container = document.getElementById('person-details-container');
        const newPersonSection = document.createElement('div');
        newPersonSection.classList.add('statement-container');
        newPersonSection.innerHTML = `
            <div style="position: relative; margin-bottom: 15px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px;">
                <button onclick="removePersonDetail(this)" class="remove-person-btn" style="position: absolute; top: 10px; right: 10px;">Remove</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <div>Name: <input type="text"></div>
                        <div style="margin-top: 5px;">Age: <input type="number"></div>
                        <div style="margin-top: 5px;">Gender: 
                            <div class="checkbox-group">
                                <label><input type="checkbox"> Male</label>
                                <label><input type="checkbox"> Female</label>
                                <label><input type="checkbox"> Other</label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div>Address: <textarea></textarea></div>
                        <div style="margin-top: 5px;">Contact: <input type="tel"></div>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <strong>Statement Category:</strong><br>
                    <div class="checkbox-group" style="margin-top: 5px;">
                        <label><input type="checkbox"> Eye Witness</label>
                        <label><input type="checkbox"> Circumstantial Witness</label>
                        <label><input type="checkbox"> Expert Witness</label>
                        <label><input type="checkbox"> Victim Statement</label>
                        <label><input type="checkbox"> Accused Statement</label>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <strong>Statement:</strong>
                    <textarea style="width: 100%; height: 200px;" placeholder="Record the detailed statement here..."></textarea>
                </div>

                <!-- Signature Pads for Each Person Row -->
                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <div>
                        <p>Signature (Statement Given By):</p>
                        <canvas class="signature-pad" style="border: 1px solid #000; width: 250px; height: 100px;"></canvas>
                        <button onclick="clearSignature(this)">Clear Signature</button>
                    </div>
                    <div>
                        <p>Signature (Statement Recorded By):</p>
                        <canvas class="signature-pad" style="border: 1px solid #000; width: 250px; height: 100px;"></canvas>
                        <button onclick="clearSignature(this)">Clear Signature</button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(newPersonSection);

        // Initialize Signature Pads for the new row
        const canvases = newPersonSection.querySelectorAll('.signature-pad');
        canvases.forEach(canvas => {
            new SignaturePad(canvas);
        });
    }

    // Function to remove a person detail section
    function removePersonDetail(btn) {
        btn.closest('.statement-container').remove();
    }

    // Function to clear a signature
    function clearSignature(button) {
        const canvas = button.previousElementSibling; // Get the canvas before the button
        if (canvas) {
            const signaturePad = new SignaturePad(canvas);
            signaturePad.clear();
        } else {
            console.error('Canvas not found!');
        }
    }

    // Function to prepare textareas for PDF generation
    function prepareForPDF() {
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            // Create a temporary div to hold the formatted content
            const tempDiv = document.createElement('div');
            tempDiv.style.width = textarea.style.width || '100%';
            tempDiv.style.minHeight = textarea.style.minHeight || '100px';
            tempDiv.style.padding = '5px';
            tempDiv.style.whiteSpace = 'pre-wrap';
            tempDiv.style.wordWrap = 'break-word';
            tempDiv.style.border = '1px solid #ccc';
            tempDiv.style.borderRadius = '4px';
            tempDiv.style.background = '#fff';

            // Replace newlines with <br> tags and set as HTML
            tempDiv.innerHTML = textarea.value.replace(/\n/g, '<br>');

            // Hide the textarea and insert the div
            textarea.style.display = 'none';
            textarea.parentNode.insertBefore(tempDiv, textarea.nextSibling);

            // Store reference to restore later
            textarea.tempDisplayDiv = tempDiv;
        });
    }

    // Function to restore textareas after PDF generation
    function restoreTextareas() {
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            if (textarea.tempDisplayDiv) {
                textarea.tempDisplayDiv.remove();
                textarea.style.display = '';
                delete textarea.tempDisplayDiv;
            }
        });
    }

    // Function to save the report as a PDF
    function saveReport() {
        const { jsPDF } = window.jspdf;
        const reportElement = document.getElementById("report-content");
        const saveButton = document.getElementById("save-button");

        if (!reportElement) {
            console.error("Error: #report-content not found!");
            return;
        }

        // Hide the save button before generating the PDF
        saveButton.classList.add('hide-in-pdf');

        // Prepare textareas for PDF
        prepareForPDF();

        // Convert signature canvases to images
        const signatureCanvases = document.querySelectorAll('.signature-pad');
        signatureCanvases.forEach(canvas => {
            const img = new Image();
            img.src = canvas.toDataURL();
            img.style.width = canvas.style.width;
            img.style.height = canvas.style.height;
            canvas.replaceWith(img);
        });

        html2canvas(reportElement, {
            scale: 2,
            logging: true,
            useCORS: true,
            allowTaint: true
        }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4");

            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            let imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
                position -= pageHeight;
                pdf.addPage();
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save("Investigation_Report.pdf");
        }).catch(error => {
            console.error("PDF Generation Error:", error);
        }).finally(() => {
            // Show the save button again after PDF generation
            saveButton.classList.remove('hide-in-pdf');
            // Restore textareas to their original state
            restoreTextareas();
            // Restore signature canvases
            const signatureImages = document.querySelectorAll('img[src^="data:image/png"]');
            signatureImages.forEach(img => {
                const canvas = document.createElement('canvas');
                canvas.style.width = img.style.width;
                canvas.style.height = img.style.height;
                img.replaceWith(canvas);
            });
        });
    }
</script>
</head>
<body>
    <div id="report-content">
        <div class="header">
            <h1>POLICE INVESTIGATION REPORT</h1>
            <h2>Final Report / Charge Sheet</h2>
            <p>Under Section 173 Cr.P.C</p>
        </div>
    
        <div class="section">
            <div class="section-title">1. CASE DETAILS</div>
            <div class="case-title">
                <div class="grid-container">
                    <div class="label">Case Title:</div>
                    <div><input type="text"></div>
                </div>
            </div>
            
            <div class="grid-container">
                <div class="label">FIR Number:</div>
                <div><input type="text"></div>
                
                <div class="label">Police Station:</div>
                <div><input type="text"></div>
                
                <div class="label">District:</div>
                <div><input type="text"></div>
                
                <div class="label">Date of Report:</div>
                <div><input type="date"></div>
                
                <div class="label">Date of Incident:</div>
                <div><input type="date"></div>
            </div>
    
            <div class="crime-details">
                <div class="label">Nature of Crime:</div>
                <textarea placeholder="Describe the nature of crime"></textarea>
                
                <div style="margin-top: 10px;">
                    <div class="label">Applicable Sections of Law:</div>
                    <textarea placeholder="List applicable legal sections"></textarea>
                </div>
    
                <div style="margin-top: 10px;">
                    <div class="label">Crime Classification:</div>
                    <div class="checkbox-group" style="margin-top: 5px;">
                        <label><input type="checkbox"> Cognizable</label>
                        <label><input type="checkbox"> Non-Cognizable</label>
                        <label><input type="checkbox"> Bailable</label>
                        <label><input type="checkbox"> Non-Bailable</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">2. PARTIES INVOLVED</div>
            <h3>Complainant Details:</h3>
            <div class="grid-container">
                <div class="label">Name:</div>
                <div><input type="text"></div>
                
                <div class="label">Address:</div>
                <div><textarea></textarea></div>
                
                <div class="label">Contact:</div>
                <div><input type="tel"></div>
            </div>
    
            <h3>Accused Details:</h3>
            <div class="grid-container">
                <div class="label">Name:</div>
                <div><input type="text"></div>
                
                <div class="label">Address:</div>
                <div><textarea></textarea></div>
                
                <div class="label">Status:</div>
                <div class="checkbox-group">
                    <label><input type="checkbox"> In Custody</label>
                    <label><input type="checkbox"> On Bail</label>
                    <label><input type="checkbox"> Absconding</label>
                </div>
            </div>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">3. SUMMARY OF EVENTS</div>
            <textarea placeholder="Provide a detailed summary of events"></textarea>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">4. EVIDENCE COLLECTED</div>
            <div style="margin-bottom: 10px;">
                <strong>Physical Evidence:</strong>
                <textarea placeholder="List physical evidence"></textarea>
            </div>
            <div style="margin-bottom: 10px;">
                <strong>Digital Evidence:</strong>
                <textarea placeholder="List digital evidence"></textarea>
            </div>
            <div>
                <strong>Documentary Evidence:</strong>
                <textarea placeholder="List documentary evidence"></textarea>
            </div>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">5. STATEMENTS RECORDED</div>
            
            <table id="statements-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <tr style="background: #eee;">
                    <th>Name</th>
                    <th>Statement Recorded Date</th>
                    <th>Statements</th>
                    <th>Section (161/164)</th>
                </tr>
                <tr>
                    <td><input type="text"></td>
                    <td><input type="date"></td>
                    <td><textarea></textarea></td>
                    <td><input type="text"></td>
                </tr>
            </table>
    
            <button onclick="addStatementRow()" class="add-row-btn">+ Add Statement Row</button>
    
            <div id="person-details-container"></div>
    
            <button onclick="addPersonDetail()" class="add-person-btn">+ Add Person Details</button>
    
            <div class="page-break"></div> <!-- Force Page Break -->
    
        <div class="section">
            <div class="section-title">6. EXPERT REPORTS</div>
            <div class="grid-container">
                <div class="label">Forensic Report:</div>
                <div class="checkbox-group">
                    <label><input type="checkbox"> Yes</label>
                    <label><input type="checkbox"> No</label>
                </div>
             <!-- Force Page Break -->   
                <div class="label">Medical Report:</div>
                <div class="checkbox-group">
                    <label><input type="checkbox"> Yes</label>
                    <label><input type="checkbox"> No</label>
                </div>
                
                <div class="label">Other Reports:</div>
                <div class="checkbox-group">
                    <label><input type="checkbox"> Yes</label>
                    <label><input type="checkbox"> No</label>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <strong>Details of Reports:</strong>
                <textarea placeholder="Provide details of expert reports"></textarea>
            </div>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">7. FINDINGS AND OBSERVATIONS</div>
            <textarea placeholder="Record findings and observations"></textarea>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">8. CONCLUSIONS</div>
            <div style="margin-bottom: 10px;">
                <strong>Sections of Law Applied:</strong>
                <textarea placeholder="List applicable sections of law"></textarea>
            </div>
            <div>
                <strong>Final Conclusion:</strong>
                <textarea placeholder="Provide the final conclusion of the investigation"></textarea>
            </div>
        </div>
        <div class="page-break"></div> <!-- Force Page Break -->
        <div class="section">
            <div class="section-title">9. RECOMMENDATIONS</div>
            <div style="margin-bottom: 10px;">
                <div class="checkbox-group">
                    <label><input type="checkbox"> Proceed with Trial</label>
                    <label><input type="checkbox"> Additional Investigation Required</label>
                    <label><input type="checkbox"> Close Investigation</label>
                    <label><input type="checkbox"> Other</label>
                </div>
            </div>
            <textarea placeholder="Additional recommendations or comments"></textarea>
        </div>
        <div class="signature-section">
            <div class="signature-box">
                <p>Investigating Officer</p>
                <p>Name: <input type="text"></p>
                <p>Badge No: <input type="text"></p>
                <p>Signature:</p>
                <canvas id="signature-pad-3" style="border: 1px solid #000; width: 250px; height: 100px;"></canvas>
                <button onclick="clearSignature('signature-pad-3')">Clear Signature</button>
            </div>
            <div class="signature-box">
                <p>Station House Officer</p>
                <p>Name: <input type="text"></p>
                <p>Badge No: <input type="text"></p>
                <p>Signature:</p>
                <canvas id="signature-pad-4" style="border: 1px solid #000; width: 250px; height: 100px;"></canvas>
                <button onclick="clearSignature('signature-pad-4')">Clear Signature</button>
            </div>
        </div>
    </div>
    <!-- Save Button (Hidden in PDF) -->
    <div class="section" style="text-align: center; margin-top: 20px;">
        <button id="save-button" onclick="saveReport()" style="
            background-color: #4CAF50; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;">
            Save Report
        </button>
    </div>
</body>
</html>